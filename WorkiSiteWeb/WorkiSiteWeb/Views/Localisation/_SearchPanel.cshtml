@model Worki.Data.Models.SearchCriteriaFormViewModel

<h3 class="blue">@Worki.Resources.Views.Search.SearchString.RefineSearch</h3>
@using (Html.BeginForm(MVC.Localisation.ActionNames.FullSearch, MVC.Localisation.Name, FormMethod.Post, new { id = "searchform" }))
{
    @Html.AntiForgeryToken()
    @Html.HiddenFor(model => model.Criteria.NorthEastLat)
    @Html.HiddenFor(model => model.Criteria.NorthEastLng)
    @Html.HiddenFor(model => model.Criteria.SouthWestLat)
    @Html.HiddenFor(model => model.Criteria.SouthWestLng)
    @Html.HiddenFor(model => model.Criteria.SearchType)
    if (Model.Criteria.SearchType == eSearchType.ePerName)
    { 
    @Html.HiddenFor(model => model.Criteria.LocalisationData.Name)
    }
	@Html.HiddenFor(model => model.Criteria.LocalisationData.Latitude)
    @Html.HiddenFor(model => model.Criteria.LocalisationData.Longitude)
    <h4 class="toogle_item toogle_trigger toogle_trigger_click active"><span class="blue">@Worki.Resources.Views.Localisation.LocalisationString.Localisation</span></h4>
    <div class="toogle_container active">
        <div class="block">
            <div class="editor-field float-left">
                @Html.TextBoxFor(model => model.Criteria.Place)
            </div>
            <input type="submit" class="buttonBlue buttonStd imageBtn refineSubmit float-right" value="@Worki.Resources.Views.Shared.SharedString.Reset"/>
            <div class="clear"></div>
        </div>
    </div>
                    
    <h4 class="toogle_item toogle_trigger toogle_trigger_click active"><span class="blue">@Worki.Resources.Views.Localisation.LocalisationFormString.Offers</span></h4>
    <div class="toogle_container active">
        <div class="block">
            <div class="editor-field">
                @Html.DropDownListFor(m => m.Criteria.OfferData.Type, Model.Offers, new { @class = "offerSelect" })
            </div>
        </div>
	</div>

    <h4 class="toogle_item toogle_trigger toogle_trigger_click active"><span class="blue">@Worki.Resources.Views.Localisation.LocalisationFormString.Facilities</span></h4>
    <div class="toogle_container active">
        <div class="block" id="serviceSelector">
            @Html.Partial(MVC.Localisation.Views._ServicesSelector)
        </div>
    </div>
                    
    <h4 class="toogle_item toogle_trigger toogle_trigger_click active"><span class="blue">@Worki.Resources.Views.Search.SearchString.KindOfLocation</span></h4>
    <div class="toogle_container active">
        <div class="block">
            <div class="editor-field">
                @Html.CheckBoxFor(model => model.Criteria.CoworkingSpace)
                @Html.LabelFor(model => model.Criteria.CoworkingSpace)
            </div>
            <div class="editor-field">
                @Html.CheckBoxFor(model => model.Criteria.Telecentre)
                @Html.LabelFor(model => model.Criteria.Telecentre)
            </div>
            <div class="editor-field">
                @Html.CheckBoxFor(model => model.Criteria.SharedOffice)
                @Html.LabelFor(model => model.Criteria.SharedOffice)
            </div>
            <div class="editor-field">
                @Html.CheckBoxFor(model => model.Criteria.BuisnessCenter)
                @Html.LabelFor(model => model.Criteria.BuisnessCenter)
            </div>
            <div class="editor-field">
                @Html.CheckBoxFor(model => model.Criteria.SpotWifi)
                @Html.LabelFor(model => model.Criteria.SpotWifi)
            </div>
            <div class="editor-field">
                @Html.CheckBoxFor(model => model.Criteria.CoffeeResto)
                @Html.LabelFor(model => model.Criteria.CoffeeResto)
            </div>
            <div class="editor-field">
                @Html.CheckBoxFor(model => model.Criteria.Biblio)
                @Html.LabelFor(model => model.Criteria.Biblio)
            </div>
            <div class="editor-field">
                @Html.CheckBoxFor(model => model.Criteria.TravelerSpace)
                @Html.LabelFor(model => model.Criteria.TravelerSpace)
            </div>
            <div class="editor-field">
                @Html.CheckBoxFor(model => model.Criteria.WorkingHotel)
                @Html.LabelFor(model => model.Criteria.WorkingHotel)
            </div>
            <div class="editor-field">
                @Html.CheckBoxFor(model => model.Criteria.PrivateArea)
                @Html.LabelFor(model => model.Criteria.PrivateArea)
            </div>
            <div class="editor-field">
                @Html.CheckBoxFor(model => model.Criteria.PublicSpace)
                @Html.LabelFor(model => model.Criteria.PublicSpace)
            </div>
            <div class="editor-field">
                @Html.CheckBoxFor(model => model.Criteria.Hotel)
                @Html.LabelFor(model => model.Criteria.Hotel)
            </div>
        </div>
    </div>

    <h4 class="toogle_item toogle_trigger toogle_trigger_click"><span class="blue">@Worki.Resources.Views.Localisation.LocalisationFormString.Services</span></h4>
    <div class="toogle_container">
        <div class="block">
            <div>
                <div id="searchOption0">
                    <div id="searchOptionToReplace">
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="clear"></div>
    @*<div class="resetSearch">
        <input type="submit" class="buttonBlue buttonStd imageBtn float-right" value="@Worki.Resources.Views.Shared.SharedString.Reset"/>
        <div class="clear"></div>
    </div>*@
}

<script type="text/javascript">
    require(["@Links.Scripts.dropdown_js"], function () {
        InitDropdown("#@DropDownModel.OrderByDD");
    });

    $('#searchFormReset input:checkbox, #serviceSelector a').live('click', function () {
        $("#searchFormReset form").submit();
    });

    $('#searchFormReset select').live('change', function () {
        $("#searchFormReset form").submit();
    });

    var goToTop = function () {
        $('html, body').animate({ scrollTop: 0 }, 0);
    }

    var hiddenClass = "visuallyhidden";
    $('.loaderBlock').addClass(hiddenClass);   // hide it initially
    jQuery.ajaxSetup({
        beforeSend: function () {
            $('.loaderBlock').removeClass(hiddenClass);
        },
        complete: function () {
            $('.loaderBlock').addClass(hiddenClass);
        },
        success: function () { }
    });

    require(["@MiscHelpers.UrlConstants.jqueryui", "http://maps.google.com/maps/api/js?sensor=true&region=FR&callback=initialize"], function () {

    });

    var resultsMap = null;
    var workiGeoCoder = null;
    function initialize() {
        require(["@Url.VersionedContent(Links.Scripts.WorkiMap_js)"], function () {
            resultsMap = new WorkiMap('resultsMap');
            var where = "@Model.Criteria.Place";
            resultsMap.LoadSearchMap(where);

            var workiAutocomplete = new WorkiAutoComplete('#Criteria_Place');
            workiAutocomplete.SetAutocomplete();

            workiGeoCoder = new WorkiGeocoder('#Criteria_LocalisationData_Latitude', '#Criteria_LocalisationData_Longitude', '#Criteria_Place');

            $("#searchFormReset form").submit();
        });
    }

    function pushResults(place, results) {
        resultsMap.ClearMap();
        var bounds = new google.maps.LatLngBounds();
        resultsMap.CenterSearchResults(place);
        for (var loc in results) {
            resultsMap.AddMarker(results[loc].latitude, results[loc].longitude, results[loc].name, bounds);
        }

        if (results.length >= 2) {
            resultsMap.FitBoundsSearchResults(bounds);
        }
    }

    var refreshResults = function (data) {
        $("#searchResults").replaceWith(data.list);
        $('div.rateit').rateit();
        //$("#mapContainer").replaceWith(data.map);
        $("#searchSelectorContainer").replaceWith(data.order);
        $(".titleDivContainer h1").html(data.title);
        $('.loaderBlock').addClass(hiddenClass);
        pushResults(data.place, data.localisations);
    };

    $(".pager a, #orderByDistance, #orderByRating").live('click', function () {
        goToTop.apply();
        $.ajax({
            url: this.href,
            success: refreshResults
        });
        return false;
    });

    require(["@Url.VersionedContent(Links.Scripts.Utils_js)", "@Url.VersionedContent(Links.Scripts.WorkiMap_js)"], function () {
        var errorBuilder = new ErrorBuilder('searchFormReset', 'searchFormError');
        var submitData = function () {
            AppAjax(
			    '@Url.Action(MVC.Localisation.AjaxFullSearch(null))',
			    "POST",
			    $('#searchFormReset form').serializeArray(),
                refreshResults,
                errorBuilder.ErrorFunc
		    );
        }

        $("#searchFormReset form").submit(function (evt) {
            goToTop.apply();

            submitData();
            return false;
        });

        $('#Criteria_Place').blur(function (evt) {
            workiGeoCoder.SearchHandler(evt, function () {
                submitData();
            });
        });
    });

    //keep search panel visible 
    var offset = $('#resultSearchBlock').offset();
    var width = $('#resultSearchBlock').width();

    $(window).scroll(function () {
        var searchBlock = $('#resultSearchBlock');
        var container = $('#globalContainer');
        var y = $(window).scrollTop();
        var yo = offset.top;
        var searchBottom = y + searchBlock.outerHeight();
        var containerBottom = yo + container.outerHeight();
        if (y < yo) {
            searchBlock.removeClass('fixed').removeClass('newbottom');
        }
        else if (y > yo && y + searchBlock.outerHeight() < yo + container.outerHeight()) {
            searchBlock.removeClass('newbottom').addClass('fixed').width(width);
        }
        else if (container.outerHeight() - searchBlock.outerHeight() > 30) {
            searchBlock.removeClass('fixed').addClass('newbottom');
        }
    });
</script>