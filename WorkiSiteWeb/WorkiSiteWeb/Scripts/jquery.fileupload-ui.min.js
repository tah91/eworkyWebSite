(function(a){a.widget("blueimpUI.fileupload",a.blueimp.fileupload,{options:{autoUpload:false,maxNumberOfFiles:undefined,maxFileSize:undefined,minFileSize:1,acceptFileTypes:/.+$/i,previewFileTypes:/^image\/(gif|jpeg|png)$/,previewMaxWidth:80,previewMaxHeight:80,previewAsCanvas:true,uploadTemplate:a("#template-upload"),downloadTemplate:a("#template-download"),dataType:"json",add:function(c,b){var d=a(this).data("fileupload");d._adjustMaxNumberOfFiles(-b.files.length);b.isAdjusted=true;b.isValidated=d._validate(b.files);b.context=d._renderUpload(b.files).appendTo(a(this).find(".files")).fadeIn(function(){a(this).show()}).data("data",b);if((d.options.autoUpload||b.autoUpload)&&b.isValidated){b.jqXHR=b.submit()}},send:function(c,b){if(!b.isValidated){var d=a(this).data("fileupload");if(!b.isAdjusted){d._adjustMaxNumberOfFiles(-b.files.length)}if(!d._validate(b.files)){return false}}if(b.context&&b.dataType&&b.dataType.substr(0,6)==="iframe"){b.context.find(".ui-progressbar").progressbar("value",parseInt(100,10))}},done:function(c,b){var d=a(this).data("fileupload");if(b.context){b.context.each(function(f){var e=(a.isArray(b.result)&&b.result[f])||{error:"emptyResult"};if(e.error){d._adjustMaxNumberOfFiles(1)}a(this).fadeOut(function(){d._renderDownload([e]).css("display","none").replaceAll(this).fadeIn(function(){a(this).show()})})})}else{d._renderDownload(b.result).css("display","none").appendTo(a(this).find(".files")).fadeIn(function(){a(this).show()})}},fail:function(c,b){var d=a(this).data("fileupload");d._adjustMaxNumberOfFiles(b.files.length);if(b.context){b.context.each(function(e){a(this).fadeOut(function(){if(b.errorThrown!=="abort"){var f=b.files[e];f.error=f.error||b.errorThrown||true;d._renderDownload([f]).css("display","none").replaceAll(this).fadeIn(function(){a(this).show()})}else{b.context.remove()}})})}else{if(b.errorThrown!=="abort"){d._adjustMaxNumberOfFiles(-b.files.length);b.context=d._renderUpload(b.files).css("display","none").appendTo(a(this).find(".files")).fadeIn(function(){a(this).show()}).data("data",b)}}},progress:function(c,b){if(b.context){b.context.find(".ui-progressbar").progressbar("value",parseInt(b.loaded/b.total*100,10))}},progressall:function(c,b){a(this).find(".fileupload-progressbar").progressbar("value",parseInt(b.loaded/b.total*100,10))},start:function(){a(this).find(".fileupload-progressbar").progressbar("value",0).fadeIn()},stop:function(){a(this).find(".fileupload-progressbar").fadeOut()},destroy:function(c,b){var d=a(this).data("fileupload");if(b.url){a.ajax(b).success(function(){d._adjustMaxNumberOfFiles(1);a(this).fadeOut(function(){a(this).remove()})})}else{b.context.fadeOut(function(){a(this).remove()})}}},_scaleImage:function(c,d){d=d||{};var b=document.createElement("canvas"),e=Math.min((d.maxWidth||c.width)/c.width,(d.maxHeight||c.height)/c.height);if(e>=1){e=Math.max((d.minWidth||c.width)/c.width,(d.minHeight||c.height)/c.height)}c.width=parseInt(c.width*e,10);c.height=parseInt(c.height*e,10);if(!d.canvas||!b.getContext){return c}b.width=c.width;b.height=c.height;b.getContext("2d").drawImage(c,0,0,c.width,c.height);return b},_createObjectURL:function(b){var c="undefined",d=(typeof window.createObjectURL!==c&&window)||(typeof URL!==c&&URL)||(typeof webkitURL!==c&&webkitURL);return d?d.createObjectURL(b):false},_revokeObjectURL:function(c){var b="undefined",d=(typeof window.revokeObjectURL!==b&&window)||(typeof URL!==b&&URL)||(typeof webkitURL!==b&&webkitURL);return d?d.revokeObjectURL(c):false},_loadFile:function(c,b){if(typeof FileReader!=="undefined"&&FileReader.prototype.readAsDataURL){var d=new FileReader();d.onload=function(f){b(f.target.result)};d.readAsDataURL(c);return true}return false},_loadImage:function(c,b,e){var f=this,g,d;if(!e||!e.fileTypes||e.fileTypes.test(c.type)){g=this._createObjectURL(c);d=a("<img>").bind("load",function(){a(this).unbind("load");f._revokeObjectURL(g);b(f._scaleImage(d[0],e))}).prop("src",g);if(!g){this._loadFile(c,function(h){d.prop("src",h)})}}},_enableDragToDesktop:function(){var b=a(this),e=b.prop("href"),c=decodeURIComponent(e.split("/").pop()).replace(/:/g,"-"),d="application/octet-stream";b.bind("dragstart",function(f){try{f.originalEvent.dataTransfer.setData("DownloadURL",[d,c,e].join(":"))}catch(g){}})},_adjustMaxNumberOfFiles:function(b){if(typeof this.options.maxNumberOfFiles==="number"){this.options.maxNumberOfFiles+=b;if(this.options.maxNumberOfFiles<1){this._disableFileInputButton()}else{this._enableFileInputButton()}}},_formatFileSize:function(b){if(typeof b.size!=="number"){return""}if(b.size>=1000000000){return(b.size/1000000000).toFixed(2)+" GB"}if(b.size>=1000000){return(b.size/1000000).toFixed(2)+" MB"}return(b.size/1000).toFixed(2)+" KB"},_hasError:function(b){if(b.error){return b.error}if(this.options.maxNumberOfFiles<0){return"maxNumberOfFiles"}if(!(this.options.acceptFileTypes.test(b.type)||this.options.acceptFileTypes.test(b.name))){return"acceptFileTypes"}if(this.options.maxFileSize&&b.size>this.options.maxFileSize){return"maxFileSize"}if(typeof b.size==="number"&&b.size<this.options.minFileSize){return"minFileSize"}return null},_validate:function(b){var c=this,d;a.each(b,function(f,e){e.error=c._hasError(e);d=!e.error});return d},_uploadTemplateHelper:function(b){b.sizef=this._formatFileSize(b);return b},_renderUploadTemplate:function(b){var c=this;return a.tmpl(this.options.uploadTemplate,a.map(b,function(d){return c._uploadTemplateHelper(d)}))},_renderUpload:function(b){var d=this,c=this.options,e=this._renderUploadTemplate(b);if(!(e instanceof a)){return a()}e.css("display","none");e.find(".progress div").slice(1).remove().end().first().progressbar();e.find(".start button").slice(this.options.autoUpload?0:1).remove().end().first().button({text:false,icons:{primary:"ui-icon-circle-arrow-e"}});e.find(".cancel button").slice(1).remove().end().first().button({text:false,icons:{primary:"ui-icon-cancel"}});e.find(".preview").each(function(f,g){d._loadImage(b[f],function(h){a(h).hide().appendTo(g).fadeIn()},{maxWidth:c.previewMaxWidth,maxHeight:c.previewMaxHeight,fileTypes:c.previewFileTypes,canvas:c.previewAsCanvas})});return e},_downloadTemplateHelper:function(b){b.sizef=this._formatFileSize(b);return b},_renderDownloadTemplate:function(b){var c=this;return a.tmpl(this.options.downloadTemplate,a.map(b,function(d){return c._downloadTemplateHelper(d)}))},_renderDownload:function(b){var c=this._renderDownloadTemplate(b);if(!(c instanceof a)){return a()}c.css("display","none");c.find(".delete button").button({text:false,icons:{primary:"ui-icon-trash"}});c.find("a").each(this._enableDragToDesktop);return c},_startHandler:function(c){c.preventDefault();var d=a(this).closest(".template-upload"),b=d.data("data");if(b&&b.submit&&!b.jqXHR){b.jqXHR=b.submit();a(this).fadeOut()}},_cancelHandler:function(c){c.preventDefault();var d=a(this).closest(".template-upload"),b=d.data("data")||{};if(!b.jqXHR){b.errorThrown="abort";c.data.fileupload._trigger("fail",c,b)}else{b.jqXHR.abort()}},_deleteHandler:function(c){c.preventDefault();var b=a(this);c.data.fileupload._trigger("destroy",c,{context:b.closest(".template-download"),url:b.attr("data-url"),type:b.attr("data-type"),dataType:c.data.fileupload.options.dataType})},_initEventHandlers:function(){a.blueimp.fileupload.prototype._initEventHandlers.call(this);var c=this.element.find(".files"),b={fileupload:this};c.find(".start button").live("click."+this.options.namespace,b,this._startHandler);c.find(".cancel button").live("click."+this.options.namespace,b,this._cancelHandler);c.find(".delete button").live("click."+this.options.namespace,b,this._deleteHandler)},_destroyEventHandlers:function(){var b=this.element.find(".files");b.find(".start button").die("click."+this.options.namespace);b.find(".cancel button").die("click."+this.options.namespace);b.find(".delete button").die("click."+this.options.namespace);a.blueimp.fileupload.prototype._destroyEventHandlers.call(this)},_initFileUploadButtonBar:function(){var c=this.element.find(".fileupload-buttonbar"),b=this.element.find(".files"),d=this.options.namespace;c.addClass("ui-widget-header ui-corner-top");this.element.find(".fileinput-button").each(function(){var e=a(this).find("input:file").detach();a(this).button({icons:{primary:"ui-icon-plusthick"}}).append(e)});c.find(".start").button({icons:{primary:"ui-icon-circle-arrow-e"}}).bind("click."+d,function(f){f.preventDefault();b.find(".start button").click()});c.find(".cancel").button({icons:{primary:"ui-icon-cancel"}}).bind("click."+d,function(f){f.preventDefault();b.find(".cancel button").click()});c.find(".delete").button({icons:{primary:"ui-icon-trash"}}).bind("click."+d,function(f){f.preventDefault();b.find(".delete button").click()})},_destroyFileUploadButtonBar:function(){this.element.find(".fileupload-buttonbar").removeClass("ui-widget-header ui-corner-top");this.element.find(".fileinput-button").each(function(){var b=a(this).find("input:file").detach();a(this).button("destroy").append(b)});this.element.find(".fileupload-buttonbar button").unbind("click."+this.options.namespace).button("destroy")},_enableFileInputButton:function(){this.element.find(".fileinput-button input:file:disabled").each(function(){var c=a(this),b=c.parent();c.detach().prop("disabled",false);b.button("enable").append(c)})},_disableFileInputButton:function(){this.element.find(".fileinput-button input:file:enabled").each(function(){var c=a(this),b=c.parent();c.detach().prop("disabled",true);b.button("disable").append(c)})},_initTemplates:function(){if(this.options.uploadTemplate instanceof a&&!this.options.uploadTemplate.length){this.options.uploadTemplate=a(this.options.uploadTemplate.selector)}if(this.options.downloadTemplate instanceof a&&!this.options.downloadTemplate.length){this.options.downloadTemplate=a(this.options.downloadTemplate.selector)}},_create:function(){a.blueimp.fileupload.prototype._create.call(this);this._initTemplates();this.element.addClass("ui-widget");this._initFileUploadButtonBar();this.element.find(".fileupload-content").addClass("ui-widget-content ui-corner-bottom");this.element.find(".fileupload-progressbar").hide().progressbar()},destroy:function(){this.element.find(".fileupload-progressbar").progressbar("destroy");this.element.find(".fileupload-content").removeClass("ui-widget-content ui-corner-bottom");this._destroyFileUploadButtonBar();this.element.removeClass("ui-widget");a.blueimp.fileupload.prototype.destroy.call(this)},enable:function(){a.blueimp.fileupload.prototype.enable.call(this);this.element.find(":ui-button").not(".fileinput-button").button("enable");this._enableFileInputButton()},disable:function(){this.element.find(":ui-button").not(".fileinput-button").button("disable");this._disableFileInputButton();a.blueimp.fileupload.prototype.disable.call(this)}})}(jQuery));