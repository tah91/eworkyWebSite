(function(a){a.widget("blueimp.fileupload",{options:{namespace:undefined,dropZone:a(document),fileInput:undefined,replaceFileInput:true,paramName:undefined,singleFileUploads:true,sequentialUploads:false,forceIframeTransport:false,multipart:true,maxChunkSize:undefined,uploadedBytes:undefined,recalculateProgress:true,formData:function(b){return b.serializeArray()},add:function(c,b){b.submit()},processData:false,contentType:false,cache:false},_refreshOptionsList:["namespace","dropZone","fileInput"],_isXHRUpload:function(b){var c="undefined";return !b.forceIframeTransport&&typeof XMLHttpRequestUpload!==c&&typeof File!==c&&(!b.multipart||typeof FormData!==c)},_getFormData:function(c){var b;if(typeof c.formData==="function"){return c.formData(c.form)}else{if(a.isArray(c.formData)){return c.formData}else{if(c.formData){b=[];a.each(c.formData,function(d,e){b.push({name:d,value:e})});return b}}}return[]},_getTotal:function(b){var c=0;a.each(b,function(e,d){c+=d.size||1});return c},_onProgress:function(c,b){if(c.lengthComputable){var f=b.total||this._getTotal(b.files),d=parseInt(c.loaded/c.total*(b.chunkSize||f),10)+(b.uploadedBytes||0);this._loaded+=d-(b.loaded||b.uploadedBytes||0);b.lengthComputable=true;b.loaded=d;b.total=f;this._trigger("progress",c,b);this._trigger("progressall",c,{lengthComputable:true,loaded:this._loaded,total:this._total})}},_initProgressListener:function(b){var c=this,d=b.xhr?b.xhr():a.ajaxSettings.xhr();if(d.upload&&d.upload.addEventListener){d.upload.addEventListener("progress",function(f){c._onProgress(f,b)},false);b.xhr=function(){return d}}},_initXHRData:function(d){var c,b=d.files[0];if(!d.multipart||d.blob){d.headers=a.extend(d.headers,{"X-File-Name":b.name,"X-File-Type":b.type,"X-File-Size":b.size});if(!d.blob){d.contentType=b.type;d.data=b}else{if(!d.multipart){d.contentType="application/octet-stream";d.data=d.blob}}}if(d.multipart){if(d.formData instanceof FormData){c=d.formData}else{c=new FormData();a.each(this._getFormData(d),function(f,e){c.append(e.name,e.value)})}if(d.blob){c.append(d.paramName,d.blob)}else{a.each(d.files,function(f,e){if(e instanceof Blob){c.append(d.paramName,e)}})}d.data=c}d.blob=null},_initIframeSettings:function(b){b.dataType="iframe "+(b.dataType||"");b.formData=this._getFormData(b)},_initDataSettings:function(b){if(this._isXHRUpload(b)){if(!this._chunkedUpload(b,true)){if(!b.data){this._initXHRData(b)}this._initProgressListener(b)}}else{this._initIframeSettings(b)}},_initFormSettings:function(b){if(!b.form||!b.form.length){b.form=a(b.fileInput.prop("form"))}if(!b.paramName){b.paramName=b.fileInput.prop("name")||"files[]"}if(!b.url){b.url=b.form.prop("action")||location.href}b.type=(b.type||b.form.prop("method")||"").toUpperCase();if(b.type!=="POST"&&b.type!=="PUT"){b.type="POST"}},_getAJAXSettings:function(b){var c=a.extend({},this.options,b);this._initFormSettings(c);this._initDataSettings(c);return c},_enhancePromise:function(b){b.success=b.done;b.error=b.fail;b.complete=b.always;return b},_getXHRPromise:function(e,b){var c=a.Deferred(),d=c.promise();b=b||this.options.context||d;if(e===true){c.resolveWith(b)}else{if(e===false){c.rejectWith(b)}}d.abort=c.promise;return this._enhancePromise(d)},_chunkedUpload:function(g,j){var k=this,b=g.files[0],c=b.size,l=g.uploadedBytes=g.uploadedBytes||0,e=g.maxChunkSize||c,i=b.webkitSlice||b.mozSlice||b.slice,m,f,d,h;if(!(this._isXHRUpload(g)&&i&&(l||e<c))||g.data){return false}if(j){return true}if(l>=c){b.error="uploadedBytes";return this._getXHRPromise(false)}f=Math.ceil((c-l)/e);m=function(n){if(!n){return k._getXHRPromise(true)}return m(n-=1).pipe(function(){var p=a.extend({},g);p.blob=i.call(b,l+n*e,l+(n+1)*e);p.chunkSize=p.blob.size;k._initXHRData(p);k._initProgressListener(p);d=(a.ajax(p)||k._getXHRPromise(false,p.context)).done(function(){if(!p.loaded){k._onProgress(a.Event("progress",{lengthComputable:true,loaded:p.chunkSize,total:p.chunkSize}),p)}g.uploadedBytes=p.uploadedBytes+=p.chunkSize});return d})};h=m(f);h.abort=function(){return d.abort()};return this._enhancePromise(h)},_beforeSend:function(c,b){if(this._active===0){this._trigger("start")}this._active+=1;this._loaded+=b.uploadedBytes||0;this._total+=this._getTotal(b.files)},_onDone:function(d,e,b,c){if(!this._isXHRUpload(c)){this._onProgress(a.Event("progress",{lengthComputable:true,loaded:1,total:1}),c)}c.result=d;c.textStatus=e;c.jqXHR=b;this._trigger("done",null,c)},_onFail:function(c,e,b,d){d.jqXHR=c;d.textStatus=e;d.errorThrown=b;this._trigger("fail",null,d);if(d.recalculateProgress){this._loaded-=d.loaded||d.uploadedBytes||0;this._total-=d.total||this._getTotal(d.files)}},_onAlways:function(d,e,b,c){this._active-=1;c.result=d;c.textStatus=e;c.jqXHR=b;this._trigger("always",null,c);if(this._active===0){this._trigger("stop");this._loaded=this._total=0}},_onSend:function(c,b){var i=this,d,g,f=i._getAJAXSettings(b),h=function(){d=((i._trigger("send",c,f)!==false&&(i._chunkedUpload(f)||a.ajax(f)))||i._getXHRPromise(false,f.context)).done(function(j,k,e){i._onDone(j,k,e,f)}).fail(function(j,k,e){i._onFail(j,k,e,f)}).always(function(j,k,e){i._onAlways(j,k,e,f)});return d};this._beforeSend(c,f);if(this.options.sequentialUploads){g=(this._sequence=this._sequence.pipe(h,h));g.abort=function(){return d.abort()};return this._enhancePromise(g)}return h()},_onAdd:function(c,b){var g=this,f=true,d=a.extend({},this.options,b);if(d.singleFileUploads&&this._isXHRUpload(d)){a.each(b.files,function(h,e){var i=a.extend({},b,{files:[e]});i.submit=function(){return g._onSend(c,i)};return(f=g._trigger("add",c,i))});return f}else{if(b.files.length){b=a.extend({},b);b.submit=function(){return g._onSend(c,b)};return this._trigger("add",c,b)}}},_normalizeFile:function(c,b){if(b.name===undefined&&b.size===undefined){b.name=b.fileName;b.size=b.fileSize}},_replaceFileInput:function(b){var c=b.clone(true);a("<form></form>").append(c)[0].reset();b.after(c).detach();this.options.fileInput=this.options.fileInput.map(function(e,d){if(d===b[0]){return c[0]}return d})},_onChange:function(c){var d=c.data.fileupload,b={files:a.each(a.makeArray(c.target.files),d._normalizeFile),fileInput:a(c.target),form:a(c.target.form)};if(!b.files.length){b.files=[{name:c.target.value.replace(/^.*\\/,"")}]}if(b.form.length){b.fileInput.data("blueimp.fileupload.form",b.form)}else{b.form=b.fileInput.data("blueimp.fileupload.form")}if(d.options.replaceFileInput){d._replaceFileInput(b.fileInput)}if(d._trigger("change",c,b)===false||d._onAdd(c,b)===false){return false}},_onDrop:function(d){var f=d.data.fileupload,c=d.dataTransfer=d.originalEvent.dataTransfer,b={files:a.each(a.makeArray(c&&c.files),f._normalizeFile)};if(f._trigger("drop",d,b)===false||f._onAdd(d,b)===false){return false}d.preventDefault()},_onDragOver:function(c){var d=c.data.fileupload,b=c.dataTransfer=c.originalEvent.dataTransfer;if(d._trigger("dragover",c)===false){return false}if(b){b.dropEffect=b.effectAllowed="copy"}c.preventDefault()},_initEventHandlers:function(){var b=this.options.namespace||this.name;this.options.dropZone.bind("dragover."+b,{fileupload:this},this._onDragOver).bind("drop."+b,{fileupload:this},this._onDrop);this.options.fileInput.bind("change."+b,{fileupload:this},this._onChange)},_destroyEventHandlers:function(){var b=this.options.namespace||this.name;this.options.dropZone.unbind("dragover."+b,this._onDragOver).unbind("drop."+b,this._onDrop);this.options.fileInput.unbind("change."+b,this._onChange)},_beforeSetOption:function(b,c){this._destroyEventHandlers()},_afterSetOption:function(b,d){var c=this.options;if(!c.fileInput){c.fileInput=a()}if(!c.dropZone){c.dropZone=a()}this._initEventHandlers()},_setOption:function(b,d){var c=a.inArray(b,this._refreshOptionsList)!==-1;if(c){this._beforeSetOption(b,d)}a.Widget.prototype._setOption.call(this,b,d);if(c){this._afterSetOption(b,d)}},_create:function(){var b=this.options;if(b.fileInput===undefined){b.fileInput=this.element.is("input:file")?this.element:this.element.find("input:file")}else{if(!b.fileInput){b.fileInput=a()}}if(!b.dropZone){b.dropZone=a()}this._sequence=this._getXHRPromise(true);this._active=this._loaded=this._total=0;this._initEventHandlers()},destroy:function(){this._destroyEventHandlers();a.Widget.prototype.destroy.call(this)},enable:function(){a.Widget.prototype.enable.call(this);this._initEventHandlers()},disable:function(){this._destroyEventHandlers();a.Widget.prototype.disable.call(this)},add:function(b){if(!b||this.options.disabled){return}b.files=a.each(a.makeArray(b.files),this._normalizeFile);this._onAdd(null,b)},send:function(b){if(b&&!this.options.disabled){b.files=a.each(a.makeArray(b.files),this._normalizeFile);if(b.files.length){return this._onSend(null,b)}}return this._getXHRPromise(false,b&&b.context)}})}(jQuery));