@model Worki.Data.Models.SearchCriteriaFormViewModel

@section HeadContent
{
    <title>@Html.WorkiTitle(Worki.Resources.Views.Search.SearchString.SearchResult)</title>
    <link href="@Url.Content(Links.Content.Search_css)" rel="stylesheet" type="text/css" />
    <link href="@Url.Content(Links.Content.rateit_css)" rel="stylesheet" type="text/css" />
    <link href="@Url.Content(Links.Content.jquery_ui_1_8_12_custom_css) " rel="stylesheet" type="text/css"/>
}				

<div class="">
    @Worki.Resources.Views.Search.SearchString.Search <span class="blue bold">@Localisation.GetOfferType(Model.Criteria.LocalisationOffer)</span> @Worki.Resources.Views.Mobile.MobileString.Near <span class="blue bold">@Model.Criteria.Place</span> @Model.Results.Count @Worki.Resources.Views.Search.SearchString.PlaceFound
</div>

<div class="clear">
</div>

<div class="detailContent">
    <div class="blockContainer">
		<div class="indexTabs">
			<ul class="tabs">
			
                <li><a href="#listTab" class="bold">@Worki.Resources.Views.Mobile.MobileString.List</a></li>
                <li><a href="#mapTab" class="bold">@Worki.Resources.Views.Mobile.MobileString.Map</a></li>
            </ul>
			<div class="tab_container clearfix">
				<div id="listTab" class="tab_content">
				    @for (int i = 0; i < Model.PageResults.Count; ++i)
					{ 
						var index = Model.PagingInfo.GlobalIndex(i);
						@Html.Partial(MVC.Mobile.Localisation.Views._SearchResultSummary, Model.GetSingleResult(index))
					}

					<div class="pager">
						@{
							RouteValueDictionary rvd = new RouteValueDictionary(ViewContext.RouteData.Values);
							foreach (string key in Request.QueryString.Keys)
							{
								rvd[key] = Request.QueryString[key].ToString();
							}
						}
						@Html.PageLinks(Model.PagingInfo, x => { rvd["page"] = x; return Url.Action(MVC.Localisation.ActionNames.FullSearchResult, rvd); })
					</div>
				</div>
				<div id="mapTab" class="tab_content">
					<div class="contentBlock">
						<div id="mobileMap" style="height:250px">
						</div>
					</div>
					<div id="currentLoc">
					</div>
				</div>
			</div>
		</div>

    </div>

	<div class="clear">
    </div>
</div>

@section ScriptContent
{
    <script type="text/javascript">
    	require(["@Url.VersionedContent(Links.Scripts.jquery_rateit_js)"]);

    	require(["@Url.VersionedContent(Links.Scripts.tabs_js)"], function () {
    		InitTab(".indexTabs");
    	});

		require(["@MiscHelpers.jqueryui", "http://maps.google.com/maps/api/js?sensor=true&region=FR&callback=initialize"], function () {

        });

        function initialize() {
            require(["@Url.VersionedContent(Links.Scripts.WorkiMap_js)"], function () {
                var resultsMap = new WorkiMap('mobileMap');
                resultsMap.LoadSearchMap();
                var where = "@Model.Criteria.Place";
                resultsMap.CenterSearchResults(where);
                var bounds = new google.maps.LatLngBounds();
				var extendCount = 0;
				var extendMax = 7;
				function addMarker(latitude, longitude, name, localisationId)
				{
					var handler = function () {
						$.ajax({
							url: "@Url.Action(MVC.Mobile.Localisation.ActionNames.LocalisationDescription, MVC.Mobile.Localisation.Name)",
							data: { "id": localisationId },
							success: function (data) {
								$("#currentLoc").html(data);
							}
						});
					}
                    var LL = new google.maps.LatLng(latitude,longitude);
                    resultsMap.LoadPin(LL, name, null, null, handler);
					extendCount++;
					if(extendCount < extendMax){
						bounds.extend(LL);
					}
				}
                @foreach (var localisation in Model.Results)
                {
					@:addMarker(@localisation.Latitude, @localisation.Longitude, "@Html.Raw(localisation.Name)", @localisation.ID);
                }
                @if (Model.Results.Count >= 2)
                {
                    <text>
                    resultsMap.FitBoundsSearchResults(bounds);
                    </text>
                }
            });   
        }
    </script>
}
